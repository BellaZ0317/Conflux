# Deployment Guide

## Conflux: Unified Personal Search Engine

Conflux is a web application that automatically extracts and indexes content you interact with across various platforms such as GitHub, HackerNews, Zotero, and Twitter. It creates a personal search engine and knowledge graph, enabling you to navigate through your documents and the tags automatically extracted from them.

This guide provides step-by-step instructions to deploy your own instance of Conflux.

---

## Prerequisites

Before you begin, ensure you have the following:

- A GitHub account.
- Accounts on the platforms you wish to integrate (Twitter, Zotero, HackerNews, etc.).
- API keys or tokens for the services you want to connect to.
- Basic knowledge of using the command line.

## Forking the Repository

1. Go to the [Conflux repository](https://github.com/BellaZ0317/Conflux) on GitHub.
2. Click the **Fork** button in the upper right corner to create your own copy of the repository.
3. Clone your forked repository to your local machine:

   ```bash
   git clone https://github.com/your-username/Conflux.git
   cd Conflux
   ```

## Configuring Secrets

Conflux requires several API keys and credentials to access different services. These secrets should be added to your repository as **GitHub Repository Secrets**.

To add a secret:

1. Go to your forked repository on GitHub.
2. Click on **Settings** > **Secrets and variables** > **Actions**.
3. Click on **New repository secret** for each of the secrets listed below.

### Twitter

To extract liked tweets:

1. Apply for a Twitter Developer account and create a project to obtain a **Bearer Token**.
2. Add the token to your repository secrets as:

   - `TWITTER_TOKEN`

### Zotero

To extract records from Zotero:

1. Create a **Group Library** in Zotero.
2. Obtain your **Zotero API Key** from [Zotero Settings](https://www.zotero.org/settings/keys).
3. Find your **Zotero Library ID**:

   - Visit your group page at `https://www.zotero.org/groups/groupname`.
   - Hover over the **Group Settings** link to see the URL, which contains your library ID after `/groups/`.

4. Add the following secrets:

   - `ZOTERO_API_KEY`
   - `ZOTERO_LIBRARY_ID`

### HackerNews

To extract upvoted posts:

1. Use your HackerNews username and password.
2. Add them to your repository secrets:

   - `HACKERNEWS_USERNAME`
   - `HACKERNEWS_PASSWORD`

### OpenAI

To enable the ChatGPT functionality for re-ranking documents:

1. Sign up for an OpenAI account and obtain your **OpenAI API Key** from [API Keys](https://platform.openai.com/account/api-keys).
2. **Important**: If you do not plan to use ChatGPT functionality, you can leave the `OPENAI_API_KEY` empty.
3. Add the secret:

   - `OPENAI_API_KEY`

### Fly.io

To deploy the API:

1. Install the `flyctl` command-line tool from [Fly.io Installation](https://fly.io/docs/hands-on/install-flyctl/).
2. Sign up for a Fly.io account:

   ```bash
   flyctl auth signup
   flyctl auth login
   ```

3. Obtain your **Fly.io API Token**:

   ```bash
   flyctl auth token
   ```

4. Add the secret:

   - `FLY_API_TOKEN`

## Modifying Source Code

### Updating Source Configuration

Update the `sources.yml` file at the root of the repository to specify the users whose content you want to index.

```yaml
github:
  - "your-github-username"
  - "another-github-username"

twitter:
  - [your-twitter-id, "your-twitter-handle"]

semanlink: False
```

- Replace the placeholders with your own GitHub usernames and Twitter user ID/handle.
- To obtain your Twitter User ID, use a tool like [tweeterid.com](https://tweeterid.com).

### Updating URLs in Frontend

After deploying your API on Fly.io, you'll have a URL like `https://your-app-name.fly.dev`.

1. Open `docs/index.html`.
2. Replace the instances of the old API URL with your own:

   ```javascript
   // Find and replace the following URL
   fetch("https://knowledge.fly.dev/...")
   // Replace with
   fetch("https://your-app-name.fly.dev/...")
   ```

   There should be three instances to replace.

### Updating CORS Origins

Update the allowed origins in the API configuration to match your GitHub Pages site.

1. Open `api/api.py`.
2. Update the `origins` list to include your GitHub Pages URL:

   ```python
   origins = [
       "https://your-username.github.io",  # Replace with your GitHub Pages URL
   ]
   ```

## Deploying the API with Fly.io

1. Ensure you have the `flyctl` CLI installed and authenticated (see [Fly.io](#flyio) section).
2. Initialize your Fly.io application:

   ```bash
   flyctl launch
   ```

   - When prompted, choose a unique app name (e.g., `conflux-api`).
   - Select a region close to you.
   - Do not launch immediately; select 'n' when asked.

3. Update the `fly.toml` file generated by `flyctl` to match your application configuration as necessary.

4. Deploy your application:

   ```bash
   flyctl deploy --build-secret OPENAI_API_KEY=$OPENAI_API_KEY
   ```

   - If not using OpenAI API, you can skip the `--build-secret` parameter.

## Setting Up GitHub Pages

Conflux's frontend is served via GitHub Pages.

1. Navigate to your repository on GitHub.
2. Click on **Settings** > **Pages**.
3. Under **Source**, select the `main` branch and `/docs` folder.
4. Save the settings.

Your site will be available at `https://your-username.github.io/Conflux/`.

## Cost Considerations

- **Fly.io**: The hosting cost on Fly.io is approximately $8 per month. The cost may increase if your API receives a large number of requests. You can set resource limits in `fly.toml` to control scaling.

  ```toml
  [services.concurrency]
    hard_limit = 6
    soft_limit = 3
    type = "connections"
  ```

  - Consider setting appropriate [VM resources](https://fly.io/docs/reference/scaling/) to manage costs.

- **OpenAI API**: If using the OpenAI API, set a usage limit in your [OpenAI Dashboard](https://platform.openai.com/account/billing/limits) to prevent unexpected charges.

## Running Locally (Development)

To run Conflux locally, you need Docker installed on your machine.

1. Export your `OPENAI_API_KEY` environment variable:

   ```bash
   export OPENAI_API_KEY="sk-..."
   ```

2. Build and run the Docker container:

   ```bash
   make launch
   ```

   - This will build the Docker image and run the API at `http://localhost:8080`.

3. You can access the frontend by opening `docs/index.html` in a browser and ensuring it points to your local API.

## References

- **Conflux Repository**: [https://github.com/BellaZ0317/Conflux](https://github.com/BellaZ0317/Conflux)
- **Fly.io Documentation**: [https://fly.io/docs/](https://fly.io/docs/)
- **OpenAI API Keys**: [https://platform.openai.com/account/api-keys](https://platform.openai.com/account/api-keys)
- **Twitter Developer Portal**: [https://developer.twitter.com/en/portal/dashboard](https://developer.twitter.com/en/portal/dashboard)
- **Zotero API Keys**: [https://www.zotero.org/settings/keys](https://www.zotero.org/settings/keys)
- **TweeterID Tool**: [https://tweeterid.com/](https://tweeterid.com/)

---

By following this guide, you should have your own instance of Conflux up and running, providing you with a unified personal search engine across your favorite platforms.

If you encounter any issues or have questions, feel free to open an issue on the [GitHub repository](https://github.com/BellaZ0317/Conflux/issues).
